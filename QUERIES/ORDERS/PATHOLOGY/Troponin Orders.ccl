SELECT DISTINCT
	PATIENT_URN = P_A.ALIAS
	, ORDER_ID = O.ORDER_ID
	, FACILITY_AT_TIME_OF_ORDER = UAR_GET_CODE_DISPLAY(E_L_H.LOC_FACILITY_CD)
	, UNIT_AT_TIME_OF_ORDER = IF(E_L_H.LOC_NURSE_UNIT_CD > 0) UAR_GET_CODE_DISPLAY(E_L_H.LOC_NURSE_UNIT_CD)
        ELSE "Unknown Unit"
        ENDIF
	, UNIT_ENCOUNTER = UAR_GET_CODE_DISPLAY(E.LOC_NURSE_UNIT_CD)
	, LOC_ROOM_DISP_AT_ORDER = UAR_GET_CODE_DISPLAY(E_L_H.LOC_ROOM_CD)
	, ORIGINAL_ORDER_DATE = FORMAT(O.ORIG_ORDER_DT_TM, "DD/MM/YYYY HH:MM:SS")
	, ITEM_PRIMARY = UAR_GET_CODE_DISPLAY (O.CATALOG_CD)
    ;, COMMENT_TYPE = UAR_GET_CODE_DISPLAY(O_C.COMMENT_TYPE_CD)
	; , COMMENT_TEXT = L_T.LONG_TEXT
	, P.BIRTH_DT_TM
	, P_SEX_DISP = UAR_GET_CODE_DISPLAY(P.SEX_CD)

FROM
	ORDERS   O
	, ENCOUNTER   E
	, ENCNTR_LOC_HIST   E_L_H
    ;, ORDER_COMMENT O_C
    ;, LONG_TEXT   L_T
	, PERSON_ALIAS   P_A
	, PERSON   P

PLAN O ;ORDERS
    WHERE
        ; ACTIVE DATA
        O.ACTIVE_IND = 1
        ; NOT A FAKE PATIENT
        AND O.PERSON_ID NOT IN (SELECT PERSON_ID FROM PERSON WHERE NAME_LAST_KEY = "*TESTWHS*")
        ;TIME FILTER
        AND O.ORIG_ORDER_DT_TM >= CNVTDATETIME("01-JAN-2022 00:00")
        AND O.ORIG_ORDER_DT_TM < CNVTDATETIME("01-JAN-2025 00:00"); CNVTDATETIME("02-AUG-2023 00:00")
        ; CATALOG TYPE
        AND O.CATALOG_CD IN (SELECT CATALOG_CD FROM ORDER_CATALOG WHERE CATALOG_TYPE_CD = 2513);LABORATORY
        ; ITEM ORDERED
        AND O.CATALOG_CD IN (SELECT CATALOG_CD FROM ORDER_CATALOG WHERE CNVTUPPER(PRIMARY_MNEMONIC) = "*TROPONIN*")
        ; A SPECIFIC ORDER
        ;WHERE O.ORDER_ID = (SELECT MAX(O_INLINE.ORDER_ID) FROM ORDERS O_INLINE) ; Gets random most recent order
JOIN    E ; ENCOUNTER
    WHERE E.ENCNTR_ID = O.ENCNTR_ID
 JOIN    E_L_H ; ENCNTR_LOC_HIST
    WHERE E_L_H.ENCNTR_ID = O.ENCNTR_ID
    AND E_L_H.ACTIVE_IND = 1    ; TO REMOVE INACTIVE ROWS THAT SEEM TO APPEAR FOR UNKNOWN REASON(S)
    AND E_L_H.BEG_EFFECTIVE_DT_TM < O.ORIG_ORDER_DT_TM  ; ENCOUNTER LOCATION BEGAN BEFORE ORDER WAS PLACED
    AND E_L_H.END_EFFECTIVE_DT_TM >  O.ORIG_ORDER_DT_TM ; ENCOUNTER LOCATION ENDED AFTER ORDER WAS PLACED
    ; HOSPITAL FILTER
    AND E.LOC_FACILITY_CD IN (
        86163400.00
        , 86163477.00
        , 85758822.00
    )


    /*
    Sunshine        86163400.00
    Williamstown        86163477.00
    Footscray       85758822.00
    */
     ;AND E_L_H.LOC_NURSE_UNIT_CD =
;  JOIN O_C ; ORDER_COMMENT
;     WHERE O_C.ORDER_ID = O.ORDER_ID
;     AND O_C.COMMENT_TYPE_CD IN (49,55)
    /*
         49.00  Clinical History
          55.00 General Clinical History
    */
;  JOIN L_T ; LONG_TEXT
;     WHERE L_T.LONG_TEXT_ID = O_C.LONG_TEXT_ID

JOIN P
	WHERE P.PERSON_ID = O.PERSON_ID
	AND P.ACTIVE_IND = 1
	AND P.END_EFFECTIVE_DT_TM > SYSDATE
 ;For Patient  URN
JOIN P_A ; PERSON_ALIAS; SELECT PATIENT_URN = P_A.ALIAS
    WHERE P_A.PERSON_ID = E.PERSON_ID
    AND
    ;this filters for the UR Number Alias' only */
    P_A.ALIAS_POOL_CD = 9569589.00
    AND
    ;Effective Only
    P_A.END_EFFECTIVE_DT_TM >CNVTDATETIME(CURDATE, curtime3)
    AND
    ;Active Only
    P_A.ACTIVE_IND = 1

WITH TIME = 1000, FORMAT