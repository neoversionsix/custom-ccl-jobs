SELECT
	URN = PA.ALIAS
	, P.NAME_FULL_FORMATTED
	, FIN = EA.ALIAS
	, E_LOC_FACILITY_DISP = UAR_GET_CODE_DISPLAY(E.LOC_FACILITY_CD)
	, E_LOCATION_DISP = UAR_GET_CODE_DISPLAY(E.LOCATION_CD)
	, E_LOC_NURSE_UNIT_DISP = UAR_GET_CODE_DISPLAY(E.LOC_NURSE_UNIT_CD)

FROM
	ENCOUNTER   E
	, PERSON   P
	, PERSON_ALIAS   PA
	, ENCNTR_ALIAS   EA

PLAN P;PERSON
	WHERE
    /* Remove Inactive Patients */
	P.ACTIVE_IND = 1
    /* Remove Fake 'Test' Patients */
    AND P.NAME_LAST_KEY = "*TESTWHS*"
    /* Remove Ineffective Patients */
    AND P.END_EFFECTIVE_DT_TM > SYSDATE

;For Patient  URN
JOIN PA;PERSON_ALIAS; PATIENT_URN = PA.ALIAS
    WHERE PA.PERSON_ID = P.PERSON_ID
    AND
    ;this filters for the UR Number Alias' only */
   	PA.ALIAS_POOL_CD = 9569589.00
	AND
    ;Effective Only
	PA.END_EFFECTIVE_DT_TM >CNVTDATETIME(CURDATE, curtime3)
    AND
    ;Active Only
    PA.ACTIVE_IND = 1

JOIN E
	WHERE E.PERSON_ID = P.PERSON_ID
	AND E.ACTIVE_IND = 1
	AND E.BEG_EFFECTIVE_DT_TM > CNVTDATETIME("01-JAN-2018 00:00:00.00")

JOIN EA;ENCNTR_ALIAS; ENCOUNTER_NO = EA.ALIAS ; EA.ENCNTR_ID = O.ENCNTR_ID
    WHERE EA.ENCNTR_ID = E.ENCNTR_ID
    /*  'FIN/ENCOUNTER/VISIT NBR' from code set 319 */
	AND EA.ENCNTR_ALIAS_TYPE_CD = 1077
	/* active FIN NBRs only */
    AND EA.ACTIVE_IND = 1
    /* effective FIN NBRs only */
	AND EA.END_EFFECTIVE_DT_TM > SYSDATE

WITH NOCOUNTER, SEPARATOR=" ", FORMAT, TIME = 10